<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ファミマ行脚</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<style>
html, body, #map { margin:0; height:100%; width:100%; }

.maplibregl-popup {
  font-size: 14px;
}
.maplibregl-popup-content {
  padding: 10px 12px;
}
.maplibregl-popup-close-button {
  font-size: 18px;
}

#searchBox {
  position: absolute;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  width: 100%;
  max-width: none;
  padding: 0 12px;
  box-sizing: border-box;
}

.search-wrapper {
  position: relative;
  width: 100%;
  box-sizing: border-box;
}

#searchInput {
  width: 100%;
  box-sizing: border-box;
  padding-right: 42px;
}

#searchResults {
  background: #ffffff;
  border-radius: 8px;
  margin-top: 6px;
  max-height: 40vh;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

.search-item {
  padding: 10px 12px;
  font-size: 14px;
  border-bottom: 1px solid #eee;
}

.search-item:last-child {
  border-bottom: none;
}

.search-item:hover {
  background: #f1f3f4;
  cursor: pointer;
}
.search-wrapper {
  position: relative;
}

#clearBtn {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 28px;
  height: 28px;

  display: none;
  align-items: center;
  justify-content: center;

  border: none;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.35);
  color: #fff;

  font-size: 18px;
  font-weight: bold;
  line-height: 1;

  cursor: pointer;
  z-index: 2;

  appearance: none;
  -webkit-appearance: none;
}

#clearBtn:hover {
  background: rgba(0, 0, 0, 0.5);
}

#searchInput {
  padding-right: 42px; /* ×の分の余白 */
}

</style>
</head>

<body>
<div id="map"></div>

<div id="searchBox">
  <div class="search-wrapper">
    <input id="searchInput" type="text" placeholder="店名で検索">
    <button id="clearBtn" type="button" aria-label="clear">×</button>
  </div>
  <div id="searchResults"></div>
</div>



<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
const map = new maplibregl.Map({
  container: 'map',
  center: [135.7, 35.0],
  zoom: 6,
  style: {
    version: 8,
    glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    sources: {
      osm: {
        type: 'raster',
        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256
      }
    },
    layers: [{
      id: 'osm',
      type: 'raster',
      source: 'osm'
    }]
  }
});

map.on('load', () => {

  let allPoints = [];

  fetch('famimaPeregrination.geojson')
  .then(res => res.json())
  .then(json => {
    allPoints = json.features || [];
  });
  
  // ポップアップ関数
  function showPopup(feature) {
    const title =
      (feature.properties.rename && feature.properties.rename.trim() !== '')
        ? `${feature.properties.name}<br>${feature.properties.rename}`
        : (feature.properties.name || '');

    const html = `
      <div style="line-height:1.4;">
        <b>${feature.properties.no}</b><br>
        ${title}<br>
        ${feature.properties.address || ''}
      </div>
    `;

    new maplibregl.Popup({
      offset: 12,
      closeButton: true,
      closeOnClick: true,
      maxWidth: '90vw'
    })
    .setLngLat(feature.geometry.coordinates)
    .setHTML(html)
    .addTo(map);
  }

  map.addSource('points', {
    type: 'geojson',
    data: 'famimaPeregrination.geojson'
  });

  // 外枠（白）
  map.addLayer({
    id: 'points-circle-outline',
    type: 'circle',
    source: 'points',
    paint: {
      'circle-radius': [
        'interpolate', ['linear'], ['zoom'],
        5, 12,
        10, 16
      ],
      'circle-color': '#ffffff'
    }
  });

  // 中身（緑）
  map.addLayer({
    id: 'points-circle-inner',
    type: 'circle',
    source: 'points',
    paint: {
      'circle-radius': [
        'interpolate', ['linear'], ['zoom'],
        5, 10,
        10, 14,
        15, 18
      ],
      'circle-color': '#1e8e3e'
    }
  });

  // 番号
  map.addLayer({
    id: 'points-number',
    type: 'symbol',
    source: 'points',
    layout: {
      'text-field': ['to-string', ['get', 'no']],
      'text-size': [
        'interpolate', ['linear'], ['zoom'],
        5, 11,
        10, 13,
        15, 15
      ],
      'text-font': ['Open Sans Semibold'],
      'text-anchor': 'center',
      'text-allow-overlap': true
    },
    paint: {
      'text-color': '#ffffff',
      'text-halo-color': 'rgba(0,0,0,0.3)',
      'text-halo-width': 1
    }
  });

  // ラベル
  map.addLayer({
    id: 'points-label',
    type: 'symbol',
    source: 'points',
    minzoom: 8,
    layout: {
      'text-field': ['get', 'name'],
      'text-size': 12,
      'text-font': ['Open Sans Semibold'],
      'text-offset': [0, 1.6],
      'text-anchor': 'top',
      'text-allow-overlap': true,
      'text-ignore-placement': true
    },
    paint: {
      'text-color': '#202124',
      'text-halo-color': '#ffffff',
      'text-halo-width': 2
    }
  });

  // クリックポップアップ
  map.on('click', 'points-number', (e) => {
    showPopup(e.features[0]);
  });

  map.on('mouseenter', 'points-number', () => {
    map.getCanvas().style.cursor = 'pointer';
  });

  map.on('mouseleave', 'points-number', () => {
    map.getCanvas().style.cursor = '';
  });

  map.once('idle', () => map.resize());
  
  const input = document.getElementById('searchInput');
  const results = document.getElementById('searchResults');

  input.addEventListener('input', () => {
    const q = input.value.trim().toLowerCase();
    results.innerHTML = '';
    if (!q) return;

    const matched = allPoints.filter(f =>
      String(f.properties.no).includes(q) ||
      (f.properties.name && f.properties.name.toLowerCase().includes(q))
    ).slice(0, 50); // 件数制限

    matched.forEach(f => {
      const div = document.createElement('div');
      div.className = 'search-item';
      div.textContent = `${f.properties.no} ${f.properties.name || ''}`;

      div.onclick = () => {
        map.flyTo({
          center: f.geometry.coordinates,
          zoom: Math.max(map.getZoom(), 12),
          speed: 1.2
        });

        showPopup(f);

        results.innerHTML = '';
        input.blur();
      };

      results.appendChild(div);
    });
  });
  
  // 検索欄全消しボタン
  const clearBtn = document.getElementById('clearBtn');

  // 入力がある時だけ × を表示
  input.addEventListener('input', () => {
    clearBtn.style.display = input.value ? 'block' : 'none';
  });

  // × を押した時
  clearBtn.addEventListener('click', () => {
    input.value = '';
    results.innerHTML = '';
    clearBtn.style.display = 'none';
    input.focus();
  });
  
  // Escキーで検索クリア（PC向け）
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (document.activeElement === input) {
        input.value = '';
        results.innerHTML = '';
        clearBtn.style.display = 'none';
        input.blur();
      }
    }
  });

});
</script>
</body>
</html>
