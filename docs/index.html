<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ファミマ行脚</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
<style>
html, body, #map { margin:0; height:100%; width:100%; }

.maplibregl-popup {
  font-size: 14px;
}
.maplibregl-popup-content {
  padding: 10px 12px;
}
.maplibregl-popup-close-button {
  font-size: 18px;
}

#searchBox {
  position: absolute;
  bottom: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 10;
  width: 90%;
  max-width: 360px;
}

#searchInput {
  width: 100%;
  padding: 10px 14px;
  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

</style>
</head>

<body>
<div id="map"></div>

<div id="searchBox">
  <input id="searchInput" type="text" placeholder="店名で検索">
</div>

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
const map = new maplibregl.Map({
  container: 'map',
  center: [139.7, 35.6],
  zoom: 6,
  style: {
    version: 8,
    glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
    sources: {
      osm: {
        type: 'raster',
        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256
      }
    },
    layers: [{
      id: 'osm',
      type: 'raster',
      source: 'osm'
    }]
  }
});

map.addControl(
  new maplibregl.NavigationControl({ visualizePitch: false }),
  'bottom-right'
);

map.on('load', () => {

  map.addSource('points', {
    type: 'geojson',
    data: 'spots.geojson'
  });

  // 外枠（白）
  map.addLayer({
    id: 'points-circle-outline',
    type: 'circle',
    source: 'points',
    paint: {
      'circle-radius': [
        'interpolate', ['linear'], ['zoom'],
        5, 12,
        10, 16
      ],
      'circle-color': '#ffffff'
    }
  });

  // 中身（緑）
  map.addLayer({
    id: 'points-circle-inner',
    type: 'circle',
    source: 'points',
    paint: {
      'circle-radius': [
        'interpolate', ['linear'], ['zoom'],
        5, 10,
        10, 14,
        15, 18
      ],
      'circle-color': '#1e8e3e'
    }
  });

  // 番号
  map.addLayer({
    id: 'points-number',
    type: 'symbol',
    source: 'points',
    layout: {
      'text-field': ['to-string', ['get', 'no']],
      'text-size': [
        'interpolate', ['linear'], ['zoom'],
        5, 11,
        10, 13,
        15, 15
      ],
      'text-font': ['Open Sans Semibold'],
      'text-anchor': 'center',
      'text-allow-overlap': true
    },
    paint: {
      'text-color': '#ffffff',
      'text-halo-color': 'rgba(0,0,0,0.3)',
      'text-halo-width': 1
    }
  });

  // ラベル
  map.addLayer({
    id: 'points-label',
    type: 'symbol',
    source: 'points',
    minzoom: 9,
    layout: {
      'text-field': ['get', 'name'],
      'text-size': 12,
      'text-font': ['Open Sans Semibold'],
      'text-offset': [0, 1.6],
      'text-anchor': 'top',
      'text-allow-overlap': true,
      'text-ignore-placement': true
    },
    paint: {
      'text-color': '#202124',
      'text-halo-color': '#ffffff',
      'text-halo-width': 2
    }
  });

  // クリックポップアップ
  map.on('click', 'points-number', (e) => {
    const f = e.features[0];

    const title =
      (f.properties.rename && f.properties.rename.trim() !== '')
        ? `${f.properties.name}<br>→ ${f.properties.rename}`
        : (f.properties.name || '');

    const html = `
      <div style="line-height:1.4;">
        <b>${f.properties.no}</b><br>
        ${title}<br>
        ${f.properties.address || ''}
      </div>
    `;

    new maplibregl.Popup({
      offset: 12,
      closeButton: true,
      closeOnClick: true,
      maxWidth: '90vw'
    })
    .setLngLat(f.geometry.coordinates)
    .setHTML(html)
    .addTo(map);
  });

  map.on('mouseenter', 'points-number', () => {
    map.getCanvas().style.cursor = 'pointer';
  });

  map.on('mouseleave', 'points-number', () => {
    map.getCanvas().style.cursor = '';
  });

  map.once('idle', () => map.resize());
  
  const input = document.getElementById('searchInput');

input.addEventListener('keydown', (e) => {
  if (e.key !== 'Enter') return;

  const q = input.value.trim();
  if (!q) return;

  const features = map.querySourceFeatures('points');

  const hit = features.find(f =>
    String(f.properties.no) === q ||
    (f.properties.name && f.properties.name.includes(q)) ||
    (f.properties.rename && f.properties.rename.includes(q))
  );

  if (!hit) {
    alert('見つかりません');
    return;
  }

  const title =
    (hit.properties.rename && hit.properties.rename.trim() !== '')
      ? `${hit.properties.name}<br>→ ${hit.properties.rename}`
      : (hit.properties.name || '');

  const html = `
    <div style="line-height:1.4;">
      <b>${hit.properties.no}</b><br>
      ${title}<br>
      ${hit.properties.address || ''}
    </div>
  `;

  map.easeTo({
    center: hit.geometry.coordinates,
    zoom: 14
  });

  new maplibregl.Popup({
    offset: 12,
    maxWidth: '90vw'
  })
  .setLngLat(hit.geometry.coordinates)
  .setHTML(html)
  .addTo(map);
});

});
</script>
</body>
</html>
